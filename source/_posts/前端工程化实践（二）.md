---
title: 前端工程化实践（二）
date: 2019-04-23 09:22:11
tags: ARWEN
---

[@vue/cli](https://cli.vuejs.org/zh/) 和 [create-react-app](https://facebook.github.io/create-react-app/) 所支持的远程部署和部署环境有关，给出的解决方案都是针对特定的部署环境的。和 [create-react-app](https://facebook.github.io/create-react-app/) 类似，[@vue/cli](https://cli.vuejs.org/zh/) 针对几个开源的提供静态资源托管服务的环境给出了部署指引，比如 [GitHub Pages](https://pages.github.com/)，[GitLab Pages](https://docs.gitlab.com/)，[Netlify](https://www.netlify.com/)，[Now](https://zeit.co/docs)，[Heroku](https://www.heroku.com/) 等等。[h_ui](https://www.npmjs.com/package/h_ui) 所面向的部署场景不太一样。

注：[@vue/cli](https://cli.vuejs.org/zh/) 在 2.x 之后就不再更新了，在 3.x 的版本上推出了 [@vue/cli](https://cli.vuejs.org/zh/)，[@vue/cli](https://cli.vuejs.org/zh/) 其实是 [@vue/cli](https://cli.vuejs.org/zh/) 最新的解决方案。事实上，[h_ui](https://www.npmjs.com/package/h_ui) 提供的模板工程很像是 [@vue/cli](https://cli.vuejs.org/zh/) 在 2.x 的基础上做 reject 之后的结果。

# 简介

很显然，我们不太可能将 [h_ui](https://www.npmjs.com/package/h_ui) 的产品部署到开源环境，更适合 [h_ui](https://www.npmjs.com/package/h_ui) 的部署方式是点对点的直接推送，在不考虑服务端缓存的情况下，这种方式无论在开发环境还是生产环境都适用。[PM2](https://pm2.io/doc/en/runtime/guide/easy-deploy-with-ssh/) 的远程部署方案 [pm2-deploy](https://github.com/Unitech/pm2-deploy) 可以做到这一点。[pm2-deploy](https://github.com/Unitech/pm2-deploy) 支持配置多个部署环境，执行 `pm2 deploy <env>` 可以将本地的静态资源轻松推送到远端。[Arwen](https://www.npmjs.com/package/@arwen/arwen-cli) 实现了与 `pm2 deploy <env>` 类似的功能，推送的处理参考了 [simple-ssh-deploy](https://www.npmjs.com/package/simple-ssh-deploy)。

# 远程部署

[Arwen](https://www.npmjs.com/package/@arwen/arwen-cli) 在 V0.1.4 的版本中新增了 `arwen push <env>` 命令支持远程部署，`<env>` 的配置如下：

```javascript
# ./package.json
{
  ...
  "arwen": {
    "type": "h_ui",                                // 项目类型标识
    "push_env": {                                  // 推送环境设置
      "development": {                             // 开发环境
        "auth": {                                  // ssh 连接配置，更多的配置项可以参考 https://github.com/mscdex/ssh2#client-methods  
          "host": "192.168.0.1",
          "port": "22",
          "username": "kawhi",
          "password": "*****"
        },
        "localFiles": "./build/**/*",              // glob 定义的本地文件路径，这里表示 ./build 目录下的所有文件
        "remotePath": "/home/kawhi/testtest",      // 远端静态资源推送路径
        "prePush": [                               // 推送前在远端执行的命令集合
          "rm -rf testtest"
        ],
        "postPush": [                              // 推送后在远端执行的命令集合
          "ls -l ./testtest"
        ],
        "silent": true                             // 是否开启推送日志
      }
    }
  }
  ...
}
```

设置 `silent` 为 true 可以打开推送日志，如果一切正常，执行 `arwen push development` 之后，会看到如下的内容：

![](/push.png)

# 典型应用

目前的 [h_ui](https://www.npmjs.com/package/h_ui) 项目多在用 [nginx](http://nginx.org/) 做静态资源服务和反向代理（当然，还有其他的应用）。在这种场景下，`arwen push <env>` 可以很方便的将编译集成后的静态文件资源推送到 [nginx](http://nginx.org/) 下指定的目录，实现静态资源的远程部署。

# 总结

`arwen push <env>` 实现的功能很单一，也很简单，有些类似的产品还实现了远端资源的版本管理，但我觉得这些功能在 [h_ui](https://www.npmjs.com/package/h_ui) 项目中意义不大。推送的实现参考了 [simple-ssh-deploy](https://www.npmjs.com/package/simple-ssh-deploy) ，做了些优化和修改，但还是有些方法有待商榷。

不管怎么说，[Arwen](https://www.npmjs.com/package/@arwen/arwen-cli) 目前实现的功能已经比较完整了，后续会对项目创建所依赖的模板工程做些优化，同时扩展其他的项目类型。现在看来，其实 [h_ui](https://www.npmjs.com/package/h_ui) 对 [Arwen](https://www.npmjs.com/package/@arwen/arwen-cli) 来说意义不大，我希望 [Arwen](https://www.npmjs.com/package/@arwen/arwen-cli) 在不同的前端框架下都可以有解决方案，比如 [React](https://www.reactjs.org/)，[Angular](https://angularjs.org/)，甚至 [jQuery](https://jquery.com/) 等等等等。我还在考虑设计一套模板插件机制，在遵循统一的运行规范的基础上，允许任何一位开发者借助 [Arwen](https://www.npmjs.com/package/@arwen/arwen-cli) 开发自己的模板，希望有时间来做这些事情。
