<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>译：Introduction to D3（二） | Kawhi's blogs</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/todo">Todo</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/外文翻译/">外文翻译</a></div><div class="post-time">2019-08-09</div></div></div><div class="container post-header"><h1>译：Introduction to D3（二）</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">目录</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#关于作者"><span class="toc-number">1.</span> <span class="toc-text">关于作者</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#介绍-D3"><span class="toc-number">2.</span> <span class="toc-text">介绍 D3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#其它的交互技术"><span class="toc-number">2.1.</span> <span class="toc-text">其它的交互技术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建提示信息"><span class="toc-number">2.1.1.</span> <span class="toc-text">创建提示信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态可点击的图例"><span class="toc-number">2.1.2.</span> <span class="toc-text">动态可点击的图例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#展示选择的性别"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">展示选择的性别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#给图例添加点击事件"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">给图例添加点击事件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction-to-D3"><span class="toc-number">3.</span> <span class="toc-text">Introduction to D3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Other-Interaction-Techniques"><span class="toc-number">3.1.</span> <span class="toc-text">Other Interaction Techniques</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Creating-tooltips"><span class="toc-number">3.1.1.</span> <span class="toc-text">Creating tooltips</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-amp-clickable-legend"><span class="toc-number">3.1.2.</span> <span class="toc-text">Dynamic &amp; clickable legend</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Displaying-the-selected-sex"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">Displaying the selected sex</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adding-click-events-to-the-legend"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">Adding click events to the legend</span></a></li></ol></li></ol></li></ol></li></ol></details></div><div class="container post-content"><p>本文是 <a href="https://observablehq.com/@uwdata/introduction-to-d3" target="_blank" rel="noopener">introduction-to-d3</a> 的最后一部分，主要内容是介绍 D3 的其他交互技术，包括创建提示信息和动态图例。</p>
<h1 id="关于作者"><a href="#关于作者" class="headerlink" title="关于作者"></a>关于作者</h1><p><img src="/2019/08/09/译：Introduction-to-D3（二）/Halden Lin, Tongshuang Wu.png" alt=""></p>
<p><a href="https://haldenl.com" target="_blank" rel="noopener">Halden Lin</a>，<a href="http://homes.cs.washington.edu/~wtshuang/" target="_blank" rel="noopener">To·ngshuang (Sherry) Wu</a>，<a href="https://idl.cs.washington.edu" target="_blank" rel="noopener">华盛顿大学交互数据实验室</a>。</p>
<h1 id="介绍-D3"><a href="#介绍-D3" class="headerlink" title="介绍 D3"></a>介绍 D3</h1><h2 id="其它的交互技术"><a href="#其它的交互技术" class="headerlink" title="其它的交互技术"></a>其它的交互技术</h2><h3 id="创建提示信息"><a href="#创建提示信息" class="headerlink" title="创建提示信息"></a>创建提示信息</h3><p>从头开始创建提示信息工具通常比较困难。和图例类似，像 d3-tip 之类的库可能会很方便。</p>
<p>引入 d3-tip：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> d3Tip <span class="keyword">from</span> <span class="string">"d3-tip"</span>;</span><br></pre></td></tr></table></figure>
<p>本质上，d3-tip 会为你创建一个可以定义样式的 HTML 元素块。当创建提示信息的时候你需要按照下面的方法来设定它：</p>
<ol>
<li>为提示信息提供一些样式。</li>
<li>设置一些偏移量使得提示信息在最上面。</li>
<li>使用 <code>html</code> 来设置你想要展示在提示信息块中的 html 元素。在函数中入参 <code>d</code> 表示提示信息依赖的底层数据。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tip: any = d3Tip()</span><br><span class="line">  .attr(<span class="string">"class"</span>, <span class="string">"d3-tip"</span>)</span><br><span class="line">  .style(<span class="string">"color"</span>, <span class="string">"white"</span>)</span><br><span class="line">  .style(<span class="string">"background-color"</span>, <span class="string">"black"</span>)</span><br><span class="line">  .style(<span class="string">"padding"</span>, <span class="string">"6px"</span>)</span><br><span class="line">  .style(<span class="string">"border-radius"</span>, <span class="string">"4px"</span>)</span><br><span class="line">  .style(<span class="string">"font-size"</span>, <span class="string">"12px"</span>)</span><br><span class="line">  .offset([<span class="number">-10</span>, <span class="number">0</span>])</span><br><span class="line">  .html(<span class="function"><span class="keyword">function</span>(<span class="params">d: Row</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;strong&gt;<span class="subst">$&#123;d3.format(<span class="string">","</span>)(d.people)&#125;</span>&lt;/strong&gt; people`</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>贴士：<code>d3.format()</code> 能帮助你以人类可读的格式展示数字。在<a href="https://github.com/d3/d3-format" target="_blank" rel="noopener">这里</a>查看更多的可能的格式！</p>
<p>用 <code>call()</code> 添加提示信息：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">container.call(tip);</span><br></pre></td></tr></table></figure>
<p>我们现在给已经绑定数据的矩形条添加事件监听，以使得提示信息可以正确的触发。</p>
<p>事件监听可以通过 <code>on()</code> 方法添加到一些特定的标记上，这些标记会对在底层的已选元素上的事件作出响应。<code>on()</code> 方法接收事件名称和一个当指定事件发生时每次都会触发的回调函数。</p>
<p>对事件监听来说，可以使用一个异步函数作为回调。回调函数的入参 <code>d</code> 表示标记的底层数据。在作用域内，<code>this</code>，相当于 DOM 元素。</p>
<p>事件监听包括：</p>
<ul>
<li>mousedown：当鼠标在一个元素上按下的时候触发</li>
<li>mouseup：当鼠标在一个元素上释放的时候触发</li>
<li>mouseover：当鼠标进入一个元素上的时候触发</li>
<li>mouseout：当鼠标在一个元素上离开的时候触发</li>
<li>mousemove：当鼠标在一个元素上移动的时候触发</li>
<li>click：当一个鼠标点击的时候触发（在一个元素上 mousedown，然后 mouseup）</li>
<li>contextmenu：当鼠标右键在一个元素上点击的时候触发</li>
<li>dblclick：当鼠标在很短事件内在一个元素上两次点击的时候触发</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">chart</span><br><span class="line">  .selectAll(<span class="string">".bar"</span>)</span><br><span class="line">  .on(<span class="string">"mouseover"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">this: HTMLElement, d: Row</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// show the tooltip on mouse over</span></span><br><span class="line">    tip.show(d, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// when the bar is mouse-overed, we slightly decrease opacity of the bar.</span></span><br><span class="line">    d3.select(<span class="keyword">this</span>).style(<span class="string">"opacity"</span>, <span class="number">0.7</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">"mouseout"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">this: HTMLElement, d: Row</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// hide the tooltip on mouse out</span></span><br><span class="line">    tip.hide();</span><br><span class="line">    d3.select(<span class="keyword">this</span>).style(<span class="string">"opacity"</span>, <span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>我们还需要给我们在更新函数中追加的柱形条（collapsed for space）添加这些事件监听。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBetter</span>(<span class="params">sex: number, step: number</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Step 3. Enter.</span></span><br><span class="line">  bars</span><br><span class="line">    .enter()</span><br><span class="line">    .append(<span class="string">"rect"</span>)</span><br><span class="line">    .attr(<span class="string">"class"</span>, <span class="string">"bar"</span>)</span><br><span class="line">    .attr(<span class="string">"x"</span>, (d: Row) =&gt; x(d.age_group))</span><br><span class="line">    .attr(<span class="string">"y"</span>, (d: Row) =&gt; y(<span class="number">0</span>))</span><br><span class="line">    .attr(<span class="string">"width"</span>, x.bandwidth())</span><br><span class="line">    .attr(<span class="string">"height"</span>, <span class="number">0</span>)</span><br><span class="line">    .attr(<span class="string">"fill"</span>, (d: Row) =&gt; color(d.sex))</span><br><span class="line">    .on(<span class="string">"mouseover"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">this: HTMLElement, d: Row</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// show the tooltip on mouse over</span></span><br><span class="line">      tip.show(d, <span class="keyword">this</span>);</span><br><span class="line">      <span class="comment">// when the bar is mouse-overed, we slightly decrease opacity of the bar.</span></span><br><span class="line">      d3.select(<span class="keyword">this</span>).style(<span class="string">"opacity"</span>, <span class="number">0.7</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .on(<span class="string">"mouseout"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">this: HTMLElement, d: Row</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// hide the tooltip on mouse out</span></span><br><span class="line">      tip.hide();</span><br><span class="line">      d3.select(<span class="keyword">this</span>).style(<span class="string">"opacity"</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .transition(<span class="string">"enter-transition"</span>)</span><br><span class="line">    .duration(<span class="number">500</span>)</span><br><span class="line">    .attr(<span class="string">"y"</span>, (d: Row) =&gt; y(d.people))</span><br><span class="line">    .attr(<span class="string">"height"</span>, (d: Row) =&gt; height - y(d.people));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在柱状条上悬停看会发生什么！</p>
<p><img src="/2019/08/09/译：Introduction-to-D3（二）/main.png" alt=""></p>
<h3 id="动态可点击的图例"><a href="#动态可点击的图例" class="headerlink" title="动态可点击的图例"></a>动态可点击的图例</h3><p>目前我们的可视化图在任意一个给定的年份上仅仅能展示一个单一的性别，如果我们能做到以下几点将会很有用：</p>
<ol>
<li>我们的图例展示已选的性别。</li>
<li>用户能够使用图例作为一个输入条件来更新我们的可视化图。</li>
</ol>
<h4 id="展示选择的性别"><a href="#展示选择的性别" class="headerlink" title="展示选择的性别"></a>展示选择的性别</h4><p>记住我们的图例是和数据绑定的！当我们手动创建它的时候，我们把它绑定在了我们的颜色域上。这意味着我们可以根据数据来设置它的样式（as we have with its fill）。</p>
<p>我们可以使用一个数据函数来设置每个矩形的透明度：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">legend.selectAll(<span class="string">".legend-rect"</span>).style(<span class="string">"opacity"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">1</span> : <span class="number">0.5</span>));</span><br></pre></td></tr></table></figure>
<p>并且类似地，我们可以加粗文本或者修改它的透明度：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">legend</span><br><span class="line">  .selectAll(<span class="string">".legend-text"</span>)</span><br><span class="line">  .style(<span class="string">"opacity"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">1</span> : <span class="number">0.5</span>))</span><br><span class="line">  .style(<span class="string">"font-weight"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">700</span> : <span class="number">400</span>));</span><br></pre></td></tr></table></figure>
<p>我们的更新函数同样也需要应用这些修改（collapsed for space）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBetter</span>(<span class="params">sex: number, step: number</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// update legend</span></span><br><span class="line">  legend.selectAll(<span class="string">".legend-rect"</span>).style(<span class="string">"opacity"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">1</span> : <span class="number">0.5</span>));</span><br><span class="line">  legend</span><br><span class="line">    .selectAll(<span class="string">".legend-text"</span>)</span><br><span class="line">    .style(<span class="string">"opacity"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">1</span> : <span class="number">0.5</span>))</span><br><span class="line">    .style(<span class="string">"font-weight"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">700</span> : <span class="number">400</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="给图例添加点击事件"><a href="#给图例添加点击事件" class="headerlink" title="给图例添加点击事件"></a>给图例添加点击事件</h4><p>要想当一个图例项被点击时执行一次更新，我们介绍一个图例项的 <code>click</code> 事件监听。当一个图例项被点击时，我们通过传递给它绑定的性别和一个 0 的步长来更新我们的可视化图。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">legend.on(<span class="string">"click"</span>, (d: number) =&gt; update(d, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>
<p>最后，我们修改图例上的光标为 <code>pointer</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">legend.style(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>);</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/09/译：Introduction-to-D3（二）/legend.png" alt=""></p>
<h1 id="Introduction-to-D3"><a href="#Introduction-to-D3" class="headerlink" title="Introduction to D3"></a>Introduction to D3</h1><h2 id="Other-Interaction-Techniques"><a href="#Other-Interaction-Techniques" class="headerlink" title="Other Interaction Techniques"></a>Other Interaction Techniques</h2><h3 id="Creating-tooltips"><a href="#Creating-tooltips" class="headerlink" title="Creating tooltips"></a>Creating tooltips</h3><p>Making tooltips from scratch is usually difficult. Similar to legends, useful libraries like d3-tip can be handy.</p>
<p>Import the library:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> d3Tip <span class="keyword">from</span> <span class="string">"d3-tip"</span>;</span><br></pre></td></tr></table></figure>
<p>Essentially, d3-tip is creating a carefully styled HTML element block for you. You will need to customize it in the following ways when creating the tooltip:</p>
<ol>
<li>Provide some style for the tooltip.</li>
<li>Make an offset so the tip is on the top.</li>
<li>Use html to set the html element you would like to display in the tooltip block. The input to the function d represents the underlying data of the mark, of which the tooltip is displaying the information.</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> tip: any = d3Tip()</span><br><span class="line">  .attr(<span class="string">"class"</span>, <span class="string">"d3-tip"</span>)</span><br><span class="line">  .style(<span class="string">"color"</span>, <span class="string">"white"</span>)</span><br><span class="line">  .style(<span class="string">"background-color"</span>, <span class="string">"black"</span>)</span><br><span class="line">  .style(<span class="string">"padding"</span>, <span class="string">"6px"</span>)</span><br><span class="line">  .style(<span class="string">"border-radius"</span>, <span class="string">"4px"</span>)</span><br><span class="line">  .style(<span class="string">"font-size"</span>, <span class="string">"12px"</span>)</span><br><span class="line">  .offset([<span class="number">-10</span>, <span class="number">0</span>])</span><br><span class="line">  .html(<span class="function"><span class="keyword">function</span>(<span class="params">d: Row</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`&lt;strong&gt;<span class="subst">$&#123;d3.format(<span class="string">","</span>)(d.people)&#125;</span>&lt;/strong&gt; people`</span>;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>Tip: d3.format() can help you display number in a more human-friendly format. Check out more possible formats <a href="https://github.com/d3/d3-format" target="_blank" rel="noopener">here</a>!</p>
<p>Add the tooltip to the figure with call():</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">container.call(tip);</span><br></pre></td></tr></table></figure>
<p>We now add events listeners to the data-binded rectangle bars, such that the tooltip is triggered correctly.</p>
<p>Event listeners can be added to marks to react to events on the underlying selection using the on() method. The on() method takes the event name and a callback function that is triggered every time the specified event happens.</p>
<p>An anonymous function can be used as the callback for the event listener. The input to the function d represents the underlying data of the mark. The scope, this, corresponds to the DOM element.</p>
<p>Event listeners include:</p>
<ul>
<li>mousedown：Triggered by an element when a mouse button is pressed down over it</li>
<li>mouseup：Triggered by an element when a mouse button is released over it</li>
<li>mouseover：Triggered by an element when the mouse comes over it</li>
<li>mouseout：Triggered by an element when the mouse goes out of it</li>
<li>mousemove：Triggered by an element on every mouse move over it.</li>
<li>click：Triggered by a mouse click: mousedown and then mouseup over an element</li>
<li>contextmenu：Triggered by a right-button mouse click over an element.</li>
<li>dblclick：Triggered by two clicks within a short time over an element</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">chart</span><br><span class="line">  .selectAll(<span class="string">".bar"</span>)</span><br><span class="line">  .on(<span class="string">"mouseover"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">this: HTMLElement, d: Row</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// show the tooltip on mouse over</span></span><br><span class="line">    tip.show(d, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// when the bar is mouse-overed, we slightly decrease opacity of the bar.</span></span><br><span class="line">    d3.select(<span class="keyword">this</span>).style(<span class="string">"opacity"</span>, <span class="number">0.7</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .on(<span class="string">"mouseout"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">this: HTMLElement, d: Row</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// hide the tooltip on mouse out</span></span><br><span class="line">    tip.hide();</span><br><span class="line">    d3.select(<span class="keyword">this</span>).style(<span class="string">"opacity"</span>, <span class="number">1</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>We also have to add these listeners to any bars we append in our update function (collapsed for space).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBetter</span>(<span class="params">sex: number, step: number</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// Step 3. Enter.</span></span><br><span class="line">  bars</span><br><span class="line">    .enter()</span><br><span class="line">    .append(<span class="string">"rect"</span>)</span><br><span class="line">    .attr(<span class="string">"class"</span>, <span class="string">"bar"</span>)</span><br><span class="line">    .attr(<span class="string">"x"</span>, (d: Row) =&gt; x(d.age_group))</span><br><span class="line">    .attr(<span class="string">"y"</span>, (d: Row) =&gt; y(<span class="number">0</span>))</span><br><span class="line">    .attr(<span class="string">"width"</span>, x.bandwidth())</span><br><span class="line">    .attr(<span class="string">"height"</span>, <span class="number">0</span>)</span><br><span class="line">    .attr(<span class="string">"fill"</span>, (d: Row) =&gt; color(d.sex))</span><br><span class="line">    .on(<span class="string">"mouseover"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">this: HTMLElement, d: Row</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// show the tooltip on mouse over</span></span><br><span class="line">      tip.show(d, <span class="keyword">this</span>);</span><br><span class="line">      <span class="comment">// when the bar is mouse-overed, we slightly decrease opacity of the bar.</span></span><br><span class="line">      d3.select(<span class="keyword">this</span>).style(<span class="string">"opacity"</span>, <span class="number">0.7</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .on(<span class="string">"mouseout"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">this: HTMLElement, d: Row</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// hide the tooltip on mouse out</span></span><br><span class="line">      tip.hide();</span><br><span class="line">      d3.select(<span class="keyword">this</span>).style(<span class="string">"opacity"</span>, <span class="number">1</span>);</span><br><span class="line">    &#125;)</span><br><span class="line">    .transition(<span class="string">"enter-transition"</span>)</span><br><span class="line">    .duration(<span class="number">500</span>)</span><br><span class="line">    .attr(<span class="string">"y"</span>, (d: Row) =&gt; y(d.people))</span><br><span class="line">    .attr(<span class="string">"height"</span>, (d: Row) =&gt; height - y(d.people));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hover on the bars to see what’s happening!</p>
<p><img src="/2019/08/09/译：Introduction-to-D3（二）/main.png" alt=""></p>
<h3 id="Dynamic-amp-clickable-legend"><a href="#Dynamic-amp-clickable-legend" class="headerlink" title="Dynamic &amp; clickable legend"></a>Dynamic &amp; clickable legend</h3><p>Since our visualizaton is only ever showing a single sex at any given point, it’d be helpful if:</p>
<ol>
<li>Our legend displayed the selected sex.</li>
<li>Users were able to use the legend as a form of input to update our visualization.</li>
</ol>
<h4 id="Displaying-the-selected-sex"><a href="#Displaying-the-selected-sex" class="headerlink" title="Displaying the selected sex"></a>Displaying the selected sex</h4><p>Remember that our legend was bound to the data! When we (manually) created it, we bound it to the domain of our color scale. This means we can style it according to this data (as we have with its fill).</p>
<p>We can make the opacity of each rect a function of the data:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">legend.selectAll(<span class="string">".legend-rect"</span>).style(<span class="string">"opacity"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">1</span> : <span class="number">0.5</span>));</span><br></pre></td></tr></table></figure>
<p>And bold the text / modify its opacity similarly</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">legend</span><br><span class="line">  .selectAll(<span class="string">".legend-text"</span>)</span><br><span class="line">  .style(<span class="string">"opacity"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">1</span> : <span class="number">0.5</span>))</span><br><span class="line">  .style(<span class="string">"font-weight"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">700</span> : <span class="number">400</span>));</span><br></pre></td></tr></table></figure>
<p>Our update function needs to apply these changes as well (collapsed for space).</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateBetter</span>(<span class="params">sex: number, step: number</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// update legend</span></span><br><span class="line">  legend.selectAll(<span class="string">".legend-rect"</span>).style(<span class="string">"opacity"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">1</span> : <span class="number">0.5</span>));</span><br><span class="line">  legend</span><br><span class="line">    .selectAll(<span class="string">".legend-text"</span>)</span><br><span class="line">    .style(<span class="string">"opacity"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">1</span> : <span class="number">0.5</span>))</span><br><span class="line">    .style(<span class="string">"font-weight"</span>, (d: number) =&gt; (d === state.sex ? <span class="number">700</span> : <span class="number">400</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Adding-click-events-to-the-legend"><a href="#Adding-click-events-to-the-legend" class="headerlink" title="Adding click events to the legend"></a>Adding click events to the legend</h4><p>To invoke an update when a legend item is clicked, we introduce a ‘click’ event listener to the legend items. When an item is clicked, we update our visualization by passing in the bound sex and a step of 0.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">legend.on(<span class="string">"click"</span>, (d: number) =&gt; update(d, <span class="number">0</span>));</span><br></pre></td></tr></table></figure>
<p>Finally, we change the cursor to be a ‘pointer’ over the legend.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">legend.style(<span class="string">"cursor"</span>, <span class="string">"pointer"</span>);</span><br></pre></td></tr></table></figure>
<p><img src="/2019/08/09/译：Introduction-to-D3（二）/legend.png" alt=""></p>
</div></div><!-- .post-main.post-comment--><!--  include _partial/comments.pug--></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>