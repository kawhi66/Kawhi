<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>条件请求和 HTTP/304 Not Modified | Kawhi's blogs</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/todo">Todo</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/HTTP/">HTTP</a></div><div class="post-time">2019-06-03</div></div></div><div class="container post-header"><h1>条件请求和 HTTP/304 Not Modified</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">目录</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#再验证"><span class="toc-number">1.</span> <span class="toc-text">再验证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#条件首部"><span class="toc-number">2.</span> <span class="toc-text">条件首部</span></a></li></ol></details></div><div class="container post-content"><p><strong>条件请求</strong>是通过 HTTP 请求中特定的首部字段实现的，这些首部字段规定了请求的前置条件，响应结果会因特定首部的值的不同而发生变化。条件请求通常用来检测服务器上存储的资源是否与客户端某一特定版本相匹配。在对某个服务器资源发送条件请求时，如果客户端已经存在该资源（缓存）而且没有过期，服务器将返回 <strong>HTTP/304 Not Modified</strong> 响应。</p>
<h1 id="再验证"><a href="#再验证" class="headerlink" title="再验证"></a>再验证</h1><p>缓存无法保存世界上每份文档的副本，即便可以有些文档也可能会经常发生变化。缓存要不时地对其进行检测，看他们保存的副本是否仍是服务器上最新的副本。这些“新鲜度检测”被称为 <strong>HTTP 再验证</strong>。</p>
<p>理论上，缓存可以在任意时刻，以任意的频率对副本进行再验证。但由于网络带宽限制，大部分缓存只有在客户端发起请求，并且副本旧得足以需要检测的时候，才会对副本进行再验证。缓存再验证可能有 3 种情况：</p>
<p><img src="/2019/06/03/HTTP-304/304.png" alt=""></p>
<ul>
<li><p><strong>再验证命中</strong><br>如果服务器对象未被修改，服务器会向客户端发送一个小（大概有 200 字节）的 <strong>HTTP/304 Not Modified</strong> 响应。</p>
</li>
<li><p><strong>再验证未命中</strong><br>如果服务器对象与已缓存副本不同，服务器向客户端发送一条普通的、带有完整内容的 HTTP/200 OK 响应。</p>
</li>
<li><p><strong>对象被删除</strong><br>如果服务器对象已经被删除了，服务器就会返回一个 HTTP/404 Not Found 响应，缓存也会将其副本删除。</p>
</li>
</ul>
<h1 id="条件首部"><a href="#条件首部" class="headerlink" title="条件首部"></a>条件首部</h1><p>HTTP 定义了 5 个条件首部（它们都是以 If- 开头），分别为：<code>If-Match</code>，<code>If-None-Match</code>，<code>If-Modified-Since</code>，<code>If-Unmodified-Since</code>，<code>If-Range</code>。对缓存再验证来说最有用的是 <code>If-Modified-Since</code> 和 <code>If-None-Match</code>。</p>
<p><img src="/2019/06/03/HTTP-304/headers.png" alt=""></p>
<p><code>If-Modified-Since</code> 首部可以与 <code>Last-Modified</code> 响应首部配合工作。缓存再验证时，条件请求会包含一个 <code>If-Modified-Since</code> 首部，其中携带有最后修改已缓存副本的日期：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If-Modified-Since: &lt;cached last-modified date&gt;</span><br></pre></td></tr></table></figure>
<p>有些时候，仅使用 <code>If-Modified-Since</code> 是不够的。HTTP 允许用户对被称为<strong>实体标签（ETag）</strong>的“版本标识符”进行比较。实体标签是附加到文档上的任意标签，它们可能包含文档的序列号或版本名，或者是文档内容的校验或其他指纹信息。当发布者对文档进行修改时，可以同步修改文档的实体标签来说明这个新的版本。这样，缓存就可以利用 <code>If-None-Match</code> 条件首部对缓存进行再验证。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">If-None-Match: <span class="string">"&lt;etag_value&gt;"</span></span><br><span class="line">If-None-Match: <span class="string">"&lt;etag_value&gt;"</span>, <span class="string">"&lt;etag_value&gt;"</span>, …</span><br><span class="line">If-None-Match: *</span><br></pre></td></tr></table></figure>
</div></div><!-- .post-main.post-comment--><!--  include _partial/comments.pug--></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>