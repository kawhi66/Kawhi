<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Vue 的响应式原理（一） | Kawhi's blogs</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/todo">Todo</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Vue/">Vue</a></div><div class="post-time">2019-05-05</div></div></div><div class="container post-header"><h1>Vue 的响应式原理（一）</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">目录</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#属性描述符"><span class="toc-number">2.</span> <span class="toc-text">属性描述符</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据描述符（数据属性）"><span class="toc-number">2.1.</span> <span class="toc-text">数据描述符（数据属性）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存取描述符（访问器属性）"><span class="toc-number">2.2.</span> <span class="toc-text">存取描述符（访问器属性）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#两个非标准方法"><span class="toc-number">2.3.</span> <span class="toc-text">两个非标准方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#可能的问题"><span class="toc-number">3.</span> <span class="toc-text">可能的问题</span></a></li></ol></details></div><div class="container post-content"><p>Vue 在组件实例初始化的时候，会遍历 data 函数返回值的所有属性，并使用 Object.defineProperty 把这些属性全部转为 getter/setter。在组件渲染的过程中，Vue 会以这些属性为依赖生成 Watcher 实例，之后当依赖项的 setter 触发时，会通知 Watcher，从而使它关联的组件重新渲染。本文是本系列文章的第一篇：理解 Object.defineProperty。</p>
<p><img src="/2019/05/05/Vue-的响应式原理（一）/render.png" alt=""></p>
<p><em>注：本文（及本系列）所有的内容都是基于 Vue V2.6.10 版本。</em></p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>该方法允许精确添加或修改对象的属性。通过赋值操作添加的普通属性是可枚举的，能够在属性枚举期间呈现出来（<code>for...in</code> 或 <code>Object.keys</code> 方法），这些属性的值可以被改变，也可以被删除。这个方法允许修改默认的额外选项（或配置），而在默认情况下，使用 Object.defineProperty 添加的属性值是不可修改的。这个方法接收三个参数：属性所在的对象、属性的名字和一个属性描述符对象。其中，属性描述符对象必须是<strong>数据描述符（数据属性）</strong>或<strong>存取描述符（访问器属性）</strong>两种形式之一；不能同时是两者。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(obj, <span class="string">'prop'</span>, &#123;</span><br><span class="line">        value: <span class="number">123</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">delete</span> obj.prop</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error) <span class="comment">// Cannot delete property 'prop' of #&lt;Object&gt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在严格模式下，删除通过 Object.defineProperty 定义的属性 <code>prop</code> 会导致异常抛出；而在非严格模式下，<code>delete obj.prop</code> 将不会产生任何效果。</p>
<h1 id="属性描述符"><a href="#属性描述符" class="headerlink" title="属性描述符"></a>属性描述符</h1><p>对象里目前存在的属性描述符有两种主要形式：<strong>数据描述符（数据属性）</strong>和<strong>存取描述符（访问器属性）</strong>。<strong>描述符必须是这两种形式之一；不能同时是两者</strong>。</p>
<h2 id="数据描述符（数据属性）"><a href="#数据描述符（数据属性）" class="headerlink" title="数据描述符（数据属性）"></a>数据描述符（数据属性）</h2><p>数据属性是一个具有值的属性，该值可能是可写的，也可能不是可写的。数据属性有 4 个描述其行为的特性：</p>
<ul>
<li>[[ Configurable ]] - 表示能否通过 <code>delete</code> 删除属性从而重新定义属性；能否修改属性的特性；或者能否把属性修改为访问器属性。通过赋值操作符直接在对象上定义的属性，他们的 [[ Configurable ]] 特性默认为 <code>true</code>。</li>
<li>[[ Enumerable ]] - 表示能否通过 <code>for...in</code> 或 <code>Object.keys</code> 方法对属性进行枚举。通过赋值操作符直接在对象上定义的属性，他们的 [[ Enumerable ]] 特性默认为 <code>true</code>。</li>
<li>[[ Writable ]] - 表示能否修改属性的值。通过赋值操作符直接在对象上定义的属性，他们的 [[ Writable ]] 特性默认为 <code>true</code>。</li>
<li>[[ Value ]] - 包含这个属性的数据值。读取属性值的时候，从这个位置读；写入属性值的时候，把新值保存在这个位置。这个特性的默认值是 <code>undefined</code>。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> obj = &#123;&#125;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(obj, <span class="string">'prop'</span>, &#123;</span><br><span class="line">        configurable: <span class="literal">true</span>,</span><br><span class="line">        enumerable: <span class="literal">false</span>, <span class="comment">// 可以省略</span></span><br><span class="line">        writable: <span class="literal">false</span>, <span class="comment">// 可以省略</span></span><br><span class="line">        value: <span class="number">123</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">delete</span> obj.prop <span class="comment">// 这里的 delete 操作不会抛出异常</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="存取描述符（访问器属性）"><a href="#存取描述符（访问器属性）" class="headerlink" title="存取描述符（访问器属性）"></a>存取描述符（访问器属性）</h2><p>访问器属性是由 getter-setter 函数对（这两个函数都不是必须的）描述的属性；访问器属性不包含数据值。在读取访问器属性时，会调用 getter 函数，这个函数负责返回有效的值；在写入访问器属性时，会调用 setter 函数并传入新值，这个函数负责决定如何处理数据。访问器属性有如下 4 个特性：</p>
<ul>
<li>[[ Configurable ]] - 表示能否通过 <code>delete</code> 删除属性从而重新定义属性；能否修改属性的特性；或者能否把属性修改为访问器属性。通过赋值操作符直接在对象上定义的属性，他们的 [[ Configurable ]] 特性默认为 <code>true</code>。</li>
<li>[[ Enumerable ]] - 表示能否通过 <code>for...in</code> 或 <code>Object.keys</code> 方法对属性进行枚举。通过赋值操作符直接在对象上定义的属性，他们的 [[ Enumerable ]] 特性默认为 <code>true</code>。</li>
<li>[[ Get ]] - 在读取属性时调用的函数。这个特性的默认值是 <code>undefined</code>。</li>
<li>[[ Set ]] - 在写入属性时调用的函数。这个特性的默认值是 <code>undefined</code>。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> book = &#123;</span><br><span class="line">        _year: <span class="number">2004</span>,</span><br><span class="line">        edition: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(book, <span class="string">'year'</span>, &#123;</span><br><span class="line">        get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>._year</span><br><span class="line">        &#125;,</span><br><span class="line">        set: <span class="function"><span class="keyword">function</span> (<span class="params">newValue</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.edition += newValue - <span class="keyword">this</span>._year</span><br><span class="line">            <span class="keyword">this</span>._year = newValue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    book.year = <span class="number">2005</span></span><br><span class="line">    <span class="built_in">console</span>.log(book.edition) <span class="comment">// 2</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码是使用访问器属性的常见方式，即设置一个属性的值会导致其他属性发生变化。不一定非要同时指定 getter 和 setter。只指定 getter 意味着属性是只读属性，尝试写入属性会被忽略，在严格模式下会抛出错误。类似地，只指定 setter 函数的属性在读取时会返回 <code>undefined</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> book = &#123;</span><br><span class="line">        _year: <span class="number">2004</span>,</span><br><span class="line">        edition: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(book, <span class="string">'year'</span>, &#123;</span><br><span class="line">        get: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>._year</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    book.year = <span class="number">2005</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error) <span class="comment">// Cannot set property year of #&lt;Object&gt; which has only a getter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> book = &#123;</span><br><span class="line">        _year: <span class="number">2004</span>,</span><br><span class="line">        edition: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(book, <span class="string">'year'</span>, &#123;</span><br><span class="line">        set: <span class="function"><span class="keyword">function</span> (<span class="params">newValue</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.edition += newValue - <span class="keyword">this</span>._year</span><br><span class="line">            <span class="keyword">this</span>._year = newValue</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    book.year = <span class="number">2005</span></span><br><span class="line">    <span class="built_in">console</span>.log(book.edition) <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">console</span>.log(book.year) <span class="comment">// undefined</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>注：只指定 setter 函数的属性在读取时，无论在严格模式还是非严格模式下都没有抛出异常，而是返回了 <code>undefined</code>。</em></p>
<h2 id="两个非标准方法"><a href="#两个非标准方法" class="headerlink" title="两个非标准方法"></a>两个非标准方法</h2><p>在 Object.defineProperty 之前，要创建访问器属性，一般都使用两个非标准的方法：<code>Object.prototype.__defineGetter__</code> 和 <code>Object.prototype.__defineSetter__</code>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> book = &#123;</span><br><span class="line">        _year: <span class="number">2004</span>,</span><br><span class="line">        edition: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    book.__defineGetter__(<span class="string">'year'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._year</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    book.__defineSetter__(<span class="string">'year'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">newValue</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.edition += newValue - <span class="keyword">this</span>._year</span><br><span class="line">        <span class="keyword">this</span>._year = newValue</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    book.year = <span class="number">2005</span></span><br><span class="line">    <span class="built_in">console</span>.log(book.edition)</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="可能的问题"><a href="#可能的问题" class="headerlink" title="可能的问题"></a>可能的问题</h1><p>需要注意的是，有些文章指出，Object.defineProperty 并不总是工作的很好，它可能会存在性能问题，比如：<a href="https://humanwhocodes.com/blog/2015/11/performance-implication-object-defineproperty/" target="_blank" rel="noopener">Hidden performance implications of Object.defineProperty()</a>。今年将要发布的 Vue3 使用 <a href="http://es6.ruanyifeng.com/#docs/proxy" target="_blank" rel="noopener">ES2015 Proxies</a> 取代了 Object.defineProperty。下一篇文章将从源码角度分析 Object.defineProperty 在 Vue 中的使用。</p>
</div></div><!-- .post-main.post-comment--><!--  include _partial/comments.pug--></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>