<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>记 Lodash 的一个安全漏洞 | Kawhi's blogs</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/font.css"><link rel="stylesheet" type="text/css" href="/css/noise.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><article class="wrapper"><div class="post-main"><div class="nav"><nav class="container"><a class="sidebar-nav-item active" href="/">Home</a><a class="sidebar-nav-item" href="/archives">Archives</a><a class="sidebar-nav-item" href="/todo">Todo</a></nav><div class="container post-meta"><div class="post-tags"><a class="post-tag-link" href="/tags/Web安全/">Web安全</a></div><div class="post-time">2019-07-17</div></div></div><div class="container post-header"><h1>记 Lodash 的一个安全漏洞</h1></div><div class="container post-toc"><details class="toc"><summary class="toc-accordion">目录</summary><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#原型和原型链"><span class="toc-number">1.</span> <span class="toc-text">原型和原型链</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#原型污染"><span class="toc-number">2.</span> <span class="toc-text">原型污染</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞防范"><span class="toc-number">3.</span> <span class="toc-text">漏洞防范</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考文章"><span class="toc-number">4.</span> <span class="toc-text">参考文章</span></a></li></ol></details></div><div class="container post-content"><p>大概在两周前，Github 上 ID 为 <a href="https://github.com/ceastman-ibm" target="_blank" rel="noopener">ceastman-ibm</a> 的用户在 <a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">Lodash</a> 的<a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">源码仓库</a>中新增了一个 <a href="https://github.com/lodash/lodash/issues/4348" target="_blank" rel="noopener">issue</a>，指出了 <a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">Lodash</a> 在 V4.17.11 版本上一个可能导致<strong>原型污染（Prototype Pollution）</strong>安全漏洞。这个漏洞使得 <a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">Lodash</a> “连夜”发版以解决潜在问题，并强烈建议开发者升级版本。遗憾的是直到昨天晚上，我才在一个微信公众号的推送文章中得知了这个消息（我关注的都是些什么玩意儿）。由此这篇博文的主要内容就是<strong>原型污染（Prototype Pollution）</strong>。</p>
<h1 id="原型和原型链"><a href="#原型和原型链" class="headerlink" title="原型和原型链"></a>原型和原型链</h1><p>每一个 JavaScript 对象（Null 除外）都和原型对象相关联，每一个对象都从原型对象继承属性。所有通过对象直接量（就是大家熟悉的<code>{}</code>）创建的对象都具有同一个原型对象，并可以通过 <code>Object.prototype</code> 获得对原型对象的引用。所有的内置构造函数（包括大部分自定义的构造函数）都具有一个继承自 <code>Object.prototype</code> 的原型，例如，<code>Date.prototype</code> 的属性继承自 <code>Object.prototype</code>，因此由 <code>new Date()</code> 创建的 <code>Date</code> 对象的属性同时继承自 <code>Date.prototype</code> 和 <code>Object.prototype</code>。这一系列链接的原型对象就是所谓的“原型链”。</p>
<p>定义在原型对象上的属性叫原型属性，这个属性非常重要，以至于我们经常把 “o 的原型属性” 直接叫做 “o 的原型”。在我看来，每一个原型属性都值得我们去关注和深入的研究，这里只列出几个比较常见的，比如 <code>constructor</code> 属性（或者叫构造函数）用来在对象实例化的时候调用和执行，<code>isPrototypeOf</code> 方法用来检测某个对象是否是另一个对象的原型（或处于原型链中），还有 <code>toString</code> 方法用来表示对象的类型信息等等。</p>
<p>Mozilla 实现的 JavaScript 对外暴露了一个专门命名为 <code>__proto__</code> 的属性，用来直接查询/设置对象的原型。需要注意的是，尽管目前 Safari 和 Chrome 的当前版本都支持它，但并不推荐使用，如果有类似的场景，请使用 <code>Object.prototype</code>。</p>
<h1 id="原型污染"><a href="#原型污染" class="headerlink" title="原型污染"></a>原型污染</h1><p>原型污染漏洞使攻击者能够修改 Web 应用程序的 JavaScript 对象原型，如果攻击者设法将属性注入现有的 JavaScript 对象原型中，就可以操纵这些属性来覆盖或污染应用程序。这样很可能会影响应用程序通过原型链处理 JavaScript 对象的过程，从而导致拒绝服务或远程代码执行出错。先来看一个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> person = &#123; <span class="attr">name</span>: <span class="string">'lucas'</span> &#125;</span><br><span class="line"><span class="built_in">console</span>.log(person.name) <span class="comment">// lucas</span></span><br><span class="line">person.__proto__.toString = <span class="function"><span class="params">()</span> =&gt;</span> &#123; alert(<span class="string">'evil'</span>) &#125;</span><br><span class="line"><span class="built_in">console</span>.log(person.name) <span class="comment">// lucas</span></span><br><span class="line"><span class="keyword">let</span> person2 = &#123;&#125;</span><br><span class="line"><span class="built_in">console</span>.log(person2.toString()) <span class="comment">// alert('evil') !!!</span></span><br></pre></td></tr></table></figure>
<p>在这个例子中，我们通过 <code>person.__proto__.toString = () =&gt; { alert(&#39;evil&#39;) }</code> 重写了 <code>person</code> 原型对象（<code>Object.prototype</code>）的 <code>toString</code> 方法，导致之后创建的对象，其继承自 <code>Object.prototype</code> 的 <code>toString</code> 属性都被污染。现在再来看 <a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">Lodash</a> 的这个严重的安全漏洞，其实原理是一样的。</p>
<p><a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">Lodash</a> 提供了 <code>defaultsDeep</code> 方法，用来分配来源对象的可枚举属性到目标对象所有解析为 <code>undefined</code> 的属性上。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_.defaultsDeep(&#123; <span class="string">'a'</span>: &#123; <span class="string">'b'</span>: <span class="number">2</span> &#125; &#125;, &#123; <span class="string">'a'</span>: &#123; <span class="string">'b'</span>: <span class="number">1</span>, <span class="string">'c'</span>: <span class="number">3</span> &#125; &#125;) <span class="comment">// &#123; 'a': &#123; 'b': 2, 'c': 3 &#125; &#125;</span></span><br></pre></td></tr></table></figure>
<p>试想，如果我们要合并的源对象是这样定义的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> payload = <span class="built_in">JSON</span>.parse(<span class="string">'&#123;"constructor": &#123;"prototype": &#123;"toString": null&#125;&#125;&#125;'</span>)</span><br></pre></td></tr></table></figure>
<p>现在再来执行 <code>_.defaultsDeep({}, payload)</code>，如果 <code>defaultsDeep</code> 方法没有对源对象中的属性做足够的校验，就很有可能触发原型污染。事实上，<a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">Lodash</a> 的修复非常简单：</p>
<p><img src="/2019/07/17/记-Lodash-的一个安全漏洞/lodash.jpg" alt=""></p>
<p>当遇见 <code>constructor</code> 以及 <code>__proto__</code> 敏感属性时退出程序。</p>
<h1 id="漏洞防范"><a href="#漏洞防范" class="headerlink" title="漏洞防范"></a>漏洞防范</h1><p><a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">Lodash</a> 暴露的此次安全漏洞在 <a href="https://snyk.io/vuln/SNYK-JS-LODASH-73638" target="_blank" rel="noopener">snyk.io</a> （这是英国一家专门检测开源代码安全漏洞的公司）上有<a href="https://snyk.io/vuln/SNYK-JS-LODASH-73638" target="_blank" rel="noopener">记录</a>，这篇文章提到了防范原型污染漏洞的方法，包括：</p>
<ul>
<li>使用 <code>Object.freeze (Object.prototype)</code> 冻结原型</li>
<li>对 JSON 输入做模式校验</li>
<li>避免使用不安全的递归合并方法</li>
<li>使用 <code>Object.create(null)</code> 创建无原型对象</li>
<li>使用 <code>Map</code> 取代 <code>Object</code></li>
</ul>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><ul>
<li><a href="https://zhuanlan.zhihu.com/p/73186974" target="_blank" rel="noopener">Lodash 严重安全漏洞背后</a></li>
<li><a href="https://mp.weixin.qq.com/s/tfZq2PZylGfMjOp8h8eeTw" target="_blank" rel="noopener">Lodash库爆出严重安全漏洞，波及400万+项目</a></li>
<li><a href="https://github.com/lodash/lodash/issues/4348" target="_blank" rel="noopener">High severity vulnerability in 4.17.11</a></li>
<li><a href="https://snyk.io/vuln/SNYK-JS-LODASH-73638" target="_blank" rel="noopener">Prototype Pollution</a></li>
</ul>
</div></div><!-- .post-main.post-comment--><!--  include _partial/comments.pug--></article><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
  $(".fancybox").fancybox();
});
</script></body></html>